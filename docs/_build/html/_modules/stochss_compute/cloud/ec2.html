
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>stochss_compute.cloud.ec2 &#8212; &#34;stochss-compute&#34; 0.9.9 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/gillespy2_alabaster_customizations.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
    <link rel="apple-touch-icon" href="../../../_static/img/stochss-compute-logo.png" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../index.html">
    <img class="logo" src="../../../_static/img/stochss-compute-logo.png" alt="Logo"/>
    
  </a>
</p>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=StochSS&repo=StochSS-Compute&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/installation/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/containers/docker.html">Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/basic_usage/basic_usage.html">Basic Usage</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/docker/docker.html">Tutorial Docker Container</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/aws/aws.html">StochSS-Compute on AWS</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../classes/stochss_compute.html">stochss_compute package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for stochss_compute.cloud.ec2</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">stochss_compute.cloud.ec2</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">secrets</span> <span class="kn">import</span> <span class="n">token_hex</span>
<span class="kn">from</span> <span class="nn">stochss_compute.client.server</span> <span class="kn">import</span> <span class="n">Server</span>
<span class="kn">from</span> <span class="nn">stochss_compute.cloud.ec2_config</span> <span class="kn">import</span> <span class="n">EC2LocalConfig</span><span class="p">,</span> <span class="n">EC2RemoteConfig</span>
<span class="kn">from</span> <span class="nn">stochss_compute.core.messages</span> <span class="kn">import</span> <span class="n">SourceIpRequest</span><span class="p">,</span> <span class="n">SourceIpResponse</span>
<span class="kn">from</span> <span class="nn">stochss_compute.cloud.exceptions</span> <span class="kn">import</span> <span class="n">EC2ImportException</span><span class="p">,</span> <span class="n">ResourceException</span><span class="p">,</span> <span class="n">EC2Exception</span>
<span class="kn">from</span> <span class="nn">stochss_compute.client.endpoint</span> <span class="kn">import</span> <span class="n">Endpoint</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">boto3</span>
    <span class="kn">from</span> <span class="nn">botocore.config</span> <span class="kn">import</span> <span class="n">Config</span>
    <span class="kn">from</span> <span class="nn">botocore.session</span> <span class="kn">import</span> <span class="n">get_session</span>
    <span class="kn">from</span> <span class="nn">botocore.exceptions</span> <span class="kn">import</span> <span class="n">ClientError</span>
    <span class="kn">from</span> <span class="nn">paramiko</span> <span class="kn">import</span> <span class="n">SSHClient</span><span class="p">,</span> <span class="n">AutoAddPolicy</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">EC2ImportException</span> <span class="kn">from</span> <span class="nn">err</span>


<span class="k">def</span> <span class="nf">_ec2_logger</span><span class="p">():</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;EC2Cluster&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">log</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
        <span class="n">_formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
        <span class="n">_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">_formatter</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">_handler</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">log</span>


<div class="viewcode-block" id="EC2Cluster"><a class="viewcode-back" href="../../../classes/stochss_compute.cloud.html#stochss_compute.cloud.ec2.EC2Cluster">[docs]</a><span class="k">class</span> <span class="nc">EC2Cluster</span><span class="p">(</span><span class="n">Server</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attempts to load a StochSS-Compute cluster. Otherwise just initializes a new cluster.</span>

<span class="sd">    :param local_config: Optional. Allows configuration of local cluster resources.</span>
<span class="sd">    :type local_config: EC2LocalConfig</span>

<span class="sd">    :param remote_config: Optional. Allows configuration of remote cluster resource identifiers.</span>
<span class="sd">    :type remote_config: EC2RemoteConfig</span>

<span class="sd">    :raises EC2Exception: possible boto3 ClientError from AWS calls. See `here &lt;https://boto3.amazonaws.com/v1/documentation/api/latest/guide/error-handling.html#aws-service-exceptions&gt;`_.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">_ec2_logger</span><span class="p">()</span>

    <span class="n">_init</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_client</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_resources</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_restricted</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_subnets</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;public&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;private&#39;</span><span class="p">:</span> <span class="kc">None</span>
    <span class="p">}</span>
    <span class="n">_default_security_group</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_server_security_group</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_vpc</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_server</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_ami</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">_local_config</span> <span class="o">=</span> <span class="n">EC2LocalConfig</span><span class="p">()</span>
    <span class="n">_remote_config</span> <span class="o">=</span> <span class="n">EC2RemoteConfig</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">remote_config</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">local_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_local_config</span> <span class="o">=</span> <span class="n">local_config</span>
        <span class="k">if</span> <span class="n">remote_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span> <span class="o">=</span> <span class="n">remote_config</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">region</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">region_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">region</span><span class="p">)</span>
            <span class="n">region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">region</span>
            <span class="c1"># Overrides any underlying configurationz</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;ec2&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;ec2&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">get_session</span><span class="p">()</span><span class="o">.</span><span class="n">get_config_variable</span><span class="p">(</span><span class="s1">&#39;region&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;ec2&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;ec2&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">ami</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ami</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">ami</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ami</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">_AMIS</span><span class="p">[</span><span class="n">region</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_status</span><span class="p">(</span><span class="s1">&#39;region error&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">EC2Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported region. Currently Supported: </span><span class="se">\</span>
<span class="s1">                                   </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">_AMIS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s1">. </span><span class="se">\</span>
<span class="s1">                                   Try providing an AMI identifier.&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err2</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_cluster</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">c_e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_status</span><span class="p">(</span><span class="n">c_e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">][</span><span class="s1">&#39;Code&#39;</span><span class="p">])</span>
            <span class="k">raise</span> <span class="n">EC2Exception</span><span class="p">(</span><span class="n">c_e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">][</span><span class="s1">&#39;Message&#39;</span><span class="p">])</span> <span class="kn">from</span> <span class="nn">c_e</span>
        <span class="k">except</span> <span class="n">ResourceException</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clean_up</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">address</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The server&#39;s IP address and port.</span>

<span class="sd">        :returns: &quot;http://{ip}:{port}&quot;</span>
<span class="sd">        :rtype: str</span>

<span class="sd">        :raises EC2Exception: Do not call before launching a cluster.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EC2Exception</span><span class="p">(</span><span class="s1">&#39;No server found. First launch a cluster.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">public_ip_address</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">public_ip_address</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EC2Exception</span><span class="p">(</span><span class="s1">&#39;No public address found.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;http://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">public_ip_address</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">api_port</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the EC2 instance status.</span>

<span class="sd">        :returns: A status set locally, or, if connected, a status fetched from the instance.</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_set_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_config</span><span class="o">.</span><span class="n">status_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_config</span><span class="o">.</span><span class="n">status_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>

<div class="viewcode-block" id="EC2Cluster.launch_single_node_instance"><a class="viewcode-back" href="../../../classes/stochss_compute.cloud.html#stochss_compute.cloud.ec2.EC2Cluster.launch_single_node_instance">[docs]</a>    <span class="k">def</span> <span class="nf">launch_single_node_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Launches a single node StochSS-Compute instance. Make sure to check instance_type pricing before launching.</span>

<span class="sd">        :param instance_type: Example: &#39;t3.nano&#39; See full list `here &lt;https://aws.amazon.com/ec2/instance-types/&gt;`_.</span>
<span class="sd">        :type instance_type: str</span>
<span class="sd">        </span>
<span class="sd">        :raises EC2Exception: possible boto3 ClientError from AWS calls. See `here &lt;https://boto3.amazonaws.com/v1/documentation/api/latest/guide/error-handling.html#aws-service-exceptions&gt;`_.</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EC2Exception</span><span class="p">(</span><span class="s1">&#39;You cannot launch more than one </span><span class="se">\</span>
<span class="s1">                               StochSS-Compute cluster instance </span><span class="se">\</span>
<span class="s1">                               per EC2Cluster object.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_status</span><span class="p">(</span><span class="s1">&#39;launching&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_launch_network</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_root_key</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_launch_head_node</span><span class="p">(</span><span class="n">instance_type</span><span class="o">=</span><span class="n">instance_type</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">c_e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_status</span><span class="p">(</span><span class="n">c_e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">][</span><span class="s1">&#39;Code&#39;</span><span class="p">])</span>
            <span class="k">raise</span> <span class="n">EC2Exception</span><span class="p">(</span><span class="n">c_e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">][</span><span class="s1">&#39;Message&#39;</span><span class="p">])</span> <span class="kn">from</span> <span class="nn">c_e</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="EC2Cluster.clean_up"><a class="viewcode-back" href="../../../classes/stochss_compute.cloud.html#stochss_compute.cloud.ec2.EC2Cluster.clean_up">[docs]</a>    <span class="k">def</span> <span class="nf">clean_up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Terminates and removes all cluster resources.</span>

<span class="sd">        :raises EC2Exception: possible boto3 ClientError from AWS calls. See `here &lt;https://boto3.amazonaws.com/v1/documentation/api/latest/guide/error-handling.html#aws-service-exceptions&gt;`_.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_status</span><span class="p">(</span><span class="s1">&#39;terminating&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">vpc_search_filter</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;tag:Name&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">vpc_name</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vpc_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">describe_vpcs</span><span class="p">(</span>
                <span class="n">Filters</span><span class="o">=</span><span class="n">vpc_search_filter</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">vpc_dict</span> <span class="ow">in</span> <span class="n">vpc_response</span><span class="p">[</span><span class="s1">&#39;Vpcs&#39;</span><span class="p">]:</span>
                <span class="n">vpc_id</span> <span class="o">=</span> <span class="n">vpc_dict</span><span class="p">[</span><span class="s1">&#39;VpcId&#39;</span><span class="p">]</span>
                <span class="n">vpc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span><span class="o">.</span><span class="n">Vpc</span><span class="p">(</span><span class="n">vpc_id</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">vpc</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="n">instance</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;Terminating &quot;</span><span class="si">%s</span><span class="s1">&quot;. This might take a minute.......&#39;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="n">instance</span><span class="o">.</span><span class="n">wait_until_terminated</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_server</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Instance &quot;</span><span class="si">%s</span><span class="s1">&quot; terminated.&#39;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">s_g</span> <span class="ow">in</span> <span class="n">vpc</span><span class="o">.</span><span class="n">security_groups</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">s_g</span><span class="o">.</span><span class="n">group_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">security_group_name</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleting &quot;</span><span class="si">%s</span><span class="s1">&quot;.......&#39;</span><span class="p">,</span> <span class="n">s_g</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                        <span class="n">s_g</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_server_security_group</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Security group &quot;</span><span class="si">%s</span><span class="s1">&quot; deleted.&#39;</span><span class="p">,</span> <span class="n">s_g</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">s_g</span><span class="o">.</span><span class="n">group_name</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_default_security_group</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">subnet</span> <span class="ow">in</span> <span class="n">vpc</span><span class="o">.</span><span class="n">subnets</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleting </span><span class="si">%s</span><span class="s1">.......&#39;</span><span class="p">,</span> <span class="n">subnet</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="n">subnet</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_subnets</span><span class="p">[</span><span class="s1">&#39;public&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Subnet </span><span class="si">%s</span><span class="s1"> deleted.&#39;</span><span class="p">,</span> <span class="n">subnet</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">igw</span> <span class="ow">in</span> <span class="n">vpc</span><span class="o">.</span><span class="n">internet_gateways</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Detaching </span><span class="si">%s</span><span class="s1">.......&#39;</span><span class="p">,</span> <span class="n">igw</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="n">igw</span><span class="o">.</span><span class="n">detach_from_vpc</span><span class="p">(</span><span class="n">VpcId</span><span class="o">=</span><span class="n">vpc</span><span class="o">.</span><span class="n">vpc_id</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Gateway </span><span class="si">%s</span><span class="s1"> detached.&#39;</span><span class="p">,</span> <span class="n">igw</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleting </span><span class="si">%s</span><span class="s1">.......&#39;</span><span class="p">,</span> <span class="n">igw</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="n">igw</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Gateway </span><span class="si">%s</span><span class="s1"> deleted.&#39;</span><span class="p">,</span> <span class="n">igw</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleting </span><span class="si">%s</span><span class="s1">.......&#39;</span><span class="p">,</span> <span class="n">vpc</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">vpc</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;VPC </span><span class="si">%s</span><span class="s1"> deleted.&#39;</span><span class="p">,</span> <span class="n">vpc</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">describe_key_pairs</span><span class="p">(</span>
                    <span class="n">KeyNames</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">key_name</span><span class="p">])</span>
                <span class="n">key_pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span><span class="o">.</span><span class="n">KeyPair</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">key_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Deleting &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">key_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Key &quot;</span><span class="si">%s</span><span class="s1">&quot; deleted.&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">key_name</span><span class="p">)</span>
                <span class="n">key_pair</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">c_e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_status</span><span class="p">(</span><span class="n">c_e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">][</span><span class="s1">&#39;Code&#39;</span><span class="p">])</span>
            <span class="k">raise</span> <span class="n">EC2Exception</span><span class="p">(</span><span class="n">c_e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">][</span><span class="s1">&#39;Message&#39;</span><span class="p">])</span> <span class="kn">from</span> <span class="nn">c_e</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delete_root_key</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_status</span><span class="p">(</span><span class="s1">&#39;terminated&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_launch_network</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Launches required network resources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Launching Network.......&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_sssc_vpc</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_sssc_subnet</span><span class="p">(</span><span class="n">public</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_sssc_subnet</span><span class="p">(</span><span class="n">public</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_sssc_security_group</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_create_root_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a key pair for SSH login and instance launch.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">create_key_pair</span><span class="p">(</span>
            <span class="n">KeyName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">key_name</span><span class="p">,</span>
            <span class="n">KeyType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_config</span><span class="o">.</span><span class="n">key_type</span><span class="p">,</span>
            <span class="n">KeyFormat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_config</span><span class="o">.</span><span class="n">key_format</span><span class="p">)</span>

        <span class="n">waiter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">get_waiter</span><span class="p">(</span><span class="s1">&#39;key_pair_exists&#39;</span><span class="p">)</span>
        <span class="n">waiter</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">KeyNames</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">key_name</span><span class="p">])</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_config</span><span class="o">.</span><span class="n">key_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_config</span><span class="o">.</span><span class="n">key_path</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">key</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;KeyMaterial&#39;</span><span class="p">])</span>
        <span class="n">key</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_config</span><span class="o">.</span><span class="n">key_path</span><span class="p">,</span> <span class="mo">0o400</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_delete_root_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes key from local filesystem if it exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_config</span><span class="o">.</span><span class="n">key_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Deleting &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_config</span><span class="o">.</span><span class="n">key_path</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_config</span><span class="o">.</span><span class="n">key_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; deleted.&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_config</span><span class="o">.</span><span class="n">key_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_sssc_vpc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a vpc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vpc_cidr_block</span> <span class="o">=</span> <span class="s1">&#39;172.31.0.0/16&#39;</span>
        <span class="n">vpc_tag</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;ResourceType&#39;</span><span class="p">:</span> <span class="s1">&#39;vpc&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Tags&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">vpc_name</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">]</span>

        <span class="n">vpc_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">create_vpc</span><span class="p">(</span>
            <span class="n">CidrBlock</span><span class="o">=</span><span class="n">vpc_cidr_block</span><span class="p">,</span> <span class="n">TagSpecifications</span><span class="o">=</span><span class="n">vpc_tag</span><span class="p">)</span>
        <span class="n">vpc_id</span> <span class="o">=</span> <span class="n">vpc_response</span><span class="p">[</span><span class="s1">&#39;Vpc&#39;</span><span class="p">][</span><span class="s1">&#39;VpcId&#39;</span><span class="p">]</span>
        <span class="n">vpc_waiter_exist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">get_waiter</span><span class="p">(</span><span class="s1">&#39;vpc_exists&#39;</span><span class="p">)</span>
        <span class="n">vpc_waiter_exist</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">VpcIds</span><span class="o">=</span><span class="p">[</span><span class="n">vpc_id</span><span class="p">])</span>
        <span class="n">vpc_waiter_avail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">get_waiter</span><span class="p">(</span><span class="s1">&#39;vpc_available&#39;</span><span class="p">)</span>
        <span class="n">vpc_waiter_avail</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">VpcIds</span><span class="o">=</span><span class="p">[</span><span class="n">vpc_id</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span><span class="o">.</span><span class="n">Vpc</span><span class="p">(</span><span class="n">vpc_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_security_group</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">sg</span> <span class="k">for</span> <span class="n">sg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span><span class="o">.</span><span class="n">security_groups</span><span class="o">.</span><span class="n">all</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">modify_vpc_attribute</span><span class="p">(</span>
            <span class="n">VpcId</span><span class="o">=</span><span class="n">vpc_id</span><span class="p">,</span> <span class="n">EnableDnsSupport</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">modify_vpc_attribute</span><span class="p">(</span>
            <span class="n">VpcId</span><span class="o">=</span><span class="n">vpc_id</span><span class="p">,</span> <span class="n">EnableDnsHostnames</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

        <span class="n">igw_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">create_internet_gateway</span><span class="p">()</span>
        <span class="n">igw_id</span> <span class="o">=</span> <span class="n">igw_response</span><span class="p">[</span><span class="s1">&#39;InternetGateway&#39;</span><span class="p">][</span><span class="s1">&#39;InternetGatewayId&#39;</span><span class="p">]</span>
        <span class="n">igw_waiter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">get_waiter</span><span class="p">(</span><span class="s1">&#39;internet_gateway_exists&#39;</span><span class="p">)</span>
        <span class="n">igw_waiter</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">InternetGatewayIds</span><span class="o">=</span><span class="p">[</span><span class="n">igw_id</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span><span class="o">.</span><span class="n">attach_internet_gateway</span><span class="p">(</span><span class="n">InternetGatewayId</span><span class="o">=</span><span class="n">igw_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rtb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span><span class="o">.</span><span class="n">route_tables</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">rtb</span><span class="o">.</span><span class="n">associations_attribute</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Main&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">rtb_id</span> <span class="o">=</span> <span class="n">rtb</span><span class="o">.</span><span class="n">route_table_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">create_route</span><span class="p">(</span>
            <span class="n">RouteTableId</span><span class="o">=</span><span class="n">rtb_id</span><span class="p">,</span> <span class="n">GatewayId</span><span class="o">=</span><span class="n">igw_id</span><span class="p">,</span> <span class="n">DestinationCidrBlock</span><span class="o">=</span><span class="s1">&#39;0.0.0.0/0&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_create_sssc_subnet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">public</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a public or private subnet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">public</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;public&#39;</span>
            <span class="n">subnet_cidr_block</span> <span class="o">=</span> <span class="s1">&#39;172.31.0.0/20&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;private&#39;</span>
            <span class="n">subnet_cidr_block</span> <span class="o">=</span> <span class="s1">&#39;172.31.16.0/20&#39;</span>

        <span class="n">subnet_tag</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;ResourceType&#39;</span><span class="p">:</span> <span class="s1">&#39;subnet&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Tags&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">subnet_name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subnets</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span><span class="o">.</span><span class="n">create_subnet</span><span class="p">(</span>
            <span class="n">CidrBlock</span><span class="o">=</span><span class="n">subnet_cidr_block</span><span class="p">,</span> <span class="n">TagSpecifications</span><span class="o">=</span><span class="n">subnet_tag</span><span class="p">)</span>
        <span class="n">waiter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">get_waiter</span><span class="p">(</span><span class="s1">&#39;subnet_available&#39;</span><span class="p">)</span>
        <span class="n">waiter</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">SubnetIds</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_subnets</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">modify_subnet_attribute</span><span class="p">(</span>
            <span class="n">SubnetId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_subnets</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">MapPublicIpOnLaunch</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subnets</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_create_sssc_security_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a security group for SSH and StochSS-Compute API access.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;Default Security Group for StochSS-Compute.&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_security_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span><span class="o">.</span><span class="n">create_security_group</span><span class="p">(</span>
            <span class="n">Description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">GroupName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">security_group_name</span><span class="p">)</span>
        <span class="n">sshargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;CidrIp&#39;</span><span class="p">:</span> <span class="s1">&#39;0.0.0.0/0&#39;</span><span class="p">,</span>
            <span class="s1">&#39;FromPort&#39;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
            <span class="s1">&#39;ToPort&#39;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
            <span class="s1">&#39;IpProtocol&#39;</span><span class="p">:</span> <span class="s1">&#39;tcp&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_security_group</span><span class="o">.</span><span class="n">authorize_ingress</span><span class="p">(</span><span class="o">**</span><span class="n">sshargs</span><span class="p">)</span>
        <span class="n">sgargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;CidrIp&#39;</span><span class="p">:</span> <span class="s1">&#39;0.0.0.0/0&#39;</span><span class="p">,</span>
            <span class="s1">&#39;FromPort&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">api_port</span><span class="p">,</span>
            <span class="s1">&#39;ToPort&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">api_port</span><span class="p">,</span>
            <span class="s1">&#39;IpProtocol&#39;</span><span class="p">:</span> <span class="s1">&#39;tcp&#39;</span><span class="p">,</span>
            <span class="s1">&#39;TagSpecifications&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;ResourceType&#39;</span><span class="p">:</span> <span class="s1">&#39;security-group-rule&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Tags&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="s1">&#39;api-server&#39;</span>
                        <span class="p">},</span>
                    <span class="p">]</span>
                <span class="p">},</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_security_group</span><span class="o">.</span><span class="n">authorize_ingress</span><span class="p">(</span><span class="o">**</span><span class="n">sgargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_security_group</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_restrict_ingress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Modifies the security group API ingress rule to</span>
<span class="sd">        only allow access on the specified port from the given ip address.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rule_filter</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;group-id&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_server_security_group</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;tag:Name&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s1">&#39;api-server&#39;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">},</span>
        <span class="p">]</span>
        <span class="n">sgr_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">describe_security_group_rules</span><span class="p">(</span>
            <span class="n">Filters</span><span class="o">=</span><span class="n">rule_filter</span><span class="p">)</span>
        <span class="n">sgr_id</span> <span class="o">=</span> <span class="n">sgr_response</span><span class="p">[</span><span class="s1">&#39;SecurityGroupRules&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;SecurityGroupRuleId&#39;</span><span class="p">]</span>
        <span class="n">new_sg_rules</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;SecurityGroupRuleId&#39;</span><span class="p">:</span> <span class="n">sgr_id</span><span class="p">,</span>
                <span class="s1">&#39;SecurityGroupRule&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;IpProtocol&#39;</span><span class="p">:</span> <span class="s1">&#39;tcp&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;FromPort&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">api_port</span><span class="p">,</span>
                    <span class="s1">&#39;ToPort&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">api_port</span><span class="p">,</span>
                    <span class="s1">&#39;CidrIpv4&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s1">/32&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Description&#39;</span><span class="p">:</span> <span class="s1">&#39;Restricts cluster access.&#39;</span>
                <span class="p">}</span>
            <span class="p">},</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">modify_security_group_rules</span><span class="p">(</span>
            <span class="n">GroupId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_server_security_group</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">SecurityGroupRules</span><span class="o">=</span><span class="n">new_sg_rules</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_security_group</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_launch_head_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Launches a StochSS-Compute server instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cloud_key</span> <span class="o">=</span> <span class="n">token_hex</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

        <span class="n">launch_commands</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;#!/bin/bash</span>
<span class="s1">sudo yum update -y</span>
<span class="s1">sudo yum -y install docker</span>
<span class="s1">sudo usermod -a -G docker ec2-user</span>
<span class="s1">sudo service docker start</span>
<span class="s1">sudo chmod 666 /var/run/docker.sock </span>
<span class="s1">docker run --network host --rm -t -e CLOUD_LOCK=</span><span class="si">{</span><span class="n">cloud_key</span><span class="si">}</span><span class="s1"> --name sssc stochss/stochss-compute:cloud stochss-compute-cluster -p </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">api_port</span><span class="si">}</span><span class="s1"> &gt; /home/ec2-user/sssc-out 2&gt; /home/ec2-user/sssc-err &amp;</span>
<span class="s1">&#39;&#39;&#39;</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;ImageId&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ami</span><span class="p">,</span>
            <span class="s1">&#39;InstanceType&#39;</span><span class="p">:</span> <span class="n">instance_type</span><span class="p">,</span>
            <span class="s1">&#39;KeyName&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">key_name</span><span class="p">,</span>
            <span class="s1">&#39;MinCount&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;MaxCount&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;SubnetId&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subnets</span><span class="p">[</span><span class="s1">&#39;public&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;SecurityGroupIds&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_security_group</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_security_group</span><span class="o">.</span><span class="n">id</span><span class="p">],</span>
            <span class="s1">&#39;TagSpecifications&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;ResourceType&#39;</span><span class="p">:</span> <span class="s1">&#39;instance&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Tags&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">server_name</span>
                        <span class="p">},</span>
                    <span class="p">]</span>
                <span class="p">},</span>
            <span class="p">],</span>
            <span class="s1">&#39;UserData&#39;</span><span class="p">:</span> <span class="n">launch_commands</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Launching StochSS-Compute server instance. This might take a minute.......&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">run_instances</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">c_e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EC2Exception</span> <span class="kn">from</span> <span class="nn">c_e</span>

        <span class="n">instance_id</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Instances&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;InstanceId&#39;</span><span class="p">]</span>
        <span class="c1"># try catch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span><span class="o">.</span><span class="n">Instance</span><span class="p">(</span><span class="n">instance_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">wait_until_exists</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">wait_until_running</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Instance &quot;</span><span class="si">%s</span><span class="s1">&quot; is running.&#39;</span><span class="p">,</span> <span class="n">instance_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_poll_launch_progress</span><span class="p">([</span><span class="s1">&#39;sssc&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Restricting server access to only your ip.&#39;</span><span class="p">)</span>
        <span class="n">source_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_source_ip</span><span class="p">(</span><span class="n">cloud_key</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_restrict_ingress</span><span class="p">(</span><span class="n">source_ip</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;StochSS-Compute ready to go!&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_poll_launch_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Polls the instance to see if the Docker container is running.</span>

<span class="sd">        :param container_names: A list of Docker container names to check against.</span>
<span class="sd">        :type container_names: List[str]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ssh</span> <span class="o">=</span> <span class="n">SSHClient</span><span class="p">()</span>
        <span class="n">ssh</span><span class="o">.</span><span class="n">set_missing_host_key_policy</span><span class="p">(</span><span class="n">AutoAddPolicy</span><span class="p">())</span>
        <span class="n">sshtries</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ssh</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">public_ip_address</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;ec2-user&#39;</span><span class="p">,</span>
                            <span class="n">key_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_config</span><span class="o">.</span><span class="n">key_path</span><span class="p">,</span> <span class="n">look_for_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sshtries</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">err</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                <span class="n">sshtries</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
        <span class="k">for</span> <span class="n">container</span> <span class="ow">in</span> <span class="n">container_names</span><span class="p">:</span>
            <span class="n">sshtries</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span>
                    <span class="s2">&quot;docker container inspect -f &#39;{{.State.Running}}&#39; &quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">recv_exit_status</span><span class="p">()</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="n">err2</span> <span class="o">=</span> <span class="n">stderr</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">ssh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">raise</span> <span class="n">EC2Exception</span><span class="p">(</span>
                        <span class="s2">&quot;Something went wrong connecting to the server. No exit status provided by the server.&quot;</span><span class="p">)</span>
                <span class="c1"># Wait for yum update, docker install, container download</span>
                <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">127</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Waiting on Docker daemon.&#39;</span><span class="p">)</span>
                    <span class="n">sshtries</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">sshtries</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="n">ssh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="k">raise</span> <span class="n">EC2Exception</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Something went wrong with Docker. Max retry attempts exceeded.</span><span class="se">\n</span><span class="s2">Error:</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">err2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;true</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
                        <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Container &quot;</span><span class="si">%s</span><span class="s1">&quot; is running.&#39;</span><span class="p">,</span> <span class="n">container</span><span class="p">)</span>
                        <span class="k">break</span>
        <span class="n">ssh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_source_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cloud_key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ping the server to find the IP address associated with the request.</span>

<span class="sd">        :param cloud_key: A secret key which must match the random key used to launch the instance.</span>
<span class="sd">        :type cloud_key: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source_ip_request</span> <span class="o">=</span> <span class="n">SourceIpRequest</span><span class="p">(</span><span class="n">cloud_key</span><span class="o">=</span><span class="n">cloud_key</span><span class="p">)</span>
        <span class="n">response_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post</span><span class="p">(</span>
            <span class="n">Endpoint</span><span class="o">.</span><span class="n">CLOUD</span><span class="p">,</span> <span class="n">sub</span><span class="o">=</span><span class="s1">&#39;/sourceip&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">source_ip_request</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">response_raw</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EC2Exception</span><span class="p">(</span><span class="n">response_raw</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">SourceIpResponse</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response_raw</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">source_ip</span>

    <span class="k">def</span> <span class="nf">_load_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Reload cluster resources. Returns False if no vpc named sssc-vpc.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">vpc_search_filter</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;tag:Name&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">vpc_name</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">]</span>
        <span class="n">vpc_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">describe_vpcs</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">vpc_search_filter</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vpc_response</span><span class="p">[</span><span class="s1">&#39;Vpcs&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_config</span><span class="o">.</span><span class="n">key_path</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_status</span><span class="p">(</span><span class="s1">&#39;key error&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">ResourceException</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">keypair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">describe_key_pairs</span><span class="p">(</span>
                        <span class="n">KeyNames</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">key_name</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">keypair</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_set_status</span><span class="p">(</span><span class="s1">&#39;key error&#39;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">ResourceException</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vpc_response</span><span class="p">[</span><span class="s1">&#39;Vpcs&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;More than one VPC named &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">vpc_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_status</span><span class="p">(</span><span class="s1">&#39;VPC error&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ResourceException</span>
        <span class="n">vpc_id</span> <span class="o">=</span> <span class="n">vpc_response</span><span class="p">[</span><span class="s1">&#39;Vpcs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;VpcId&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span><span class="o">.</span><span class="n">Vpc</span><span class="p">(</span><span class="n">vpc_id</span><span class="p">)</span>
        <span class="n">vpc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">vpc</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;Key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Name&#39;</span> <span class="ow">and</span> <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">server_name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_server</span> <span class="o">=</span> <span class="n">instance</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No instances named &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">server_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_status</span><span class="p">(</span><span class="s1">&#39;server error&#39;</span><span class="p">)</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">s_g</span> <span class="ow">in</span> <span class="n">vpc</span><span class="o">.</span><span class="n">security_groups</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">s_g</span><span class="o">.</span><span class="n">group_name</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_default_security_group</span> <span class="o">=</span> <span class="n">s_g</span>
            <span class="k">if</span> <span class="n">s_g</span><span class="o">.</span><span class="n">group_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">security_group_name</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">s_g</span><span class="o">.</span><span class="n">ip_permissions</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;FromPort&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">api_port</span> \
                            <span class="ow">and</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;ToPort&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">api_port</span> \
                            <span class="ow">and</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;IpRanges&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;CidrIp&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0.0.0.0/0&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Security Group rule error.&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_set_status</span><span class="p">(</span><span class="s1">&#39;security group error&#39;</span><span class="p">)</span>
                        <span class="n">errors</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_server_security_group</span> <span class="o">=</span> <span class="n">s_g</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_security_group</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No security group named &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">security_group_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_status</span><span class="p">(</span><span class="s1">&#39;security group error&#39;</span><span class="p">)</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">subnet</span> <span class="ow">in</span> <span class="n">vpc</span><span class="o">.</span><span class="n">subnets</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">subnet</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;Key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Name&#39;</span> <span class="ow">and</span> <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">subnet_name</span><span class="si">}</span><span class="s1">-public&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_subnets</span><span class="p">[</span><span class="s1">&#39;public&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subnet</span>
                <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;Key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Name&#39;</span> <span class="ow">and</span> <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_remote_config</span><span class="o">.</span><span class="n">subnet_name</span><span class="si">}</span><span class="s1">-private&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_subnets</span><span class="p">[</span><span class="s1">&#39;private&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subnet</span>
        <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subnets</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Missing or misconfigured subnet.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_status</span><span class="p">(</span><span class="s1">&#39;subnet error&#39;</span><span class="p">)</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">errors</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ResourceException</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Cluster loaded.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="kc">True</span></div>
</pre></div>

          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;"Copyright (C) 2017-2023".
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 6.1.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    
    <a href="https://github.com/StochSS/StochSS-Compute" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>